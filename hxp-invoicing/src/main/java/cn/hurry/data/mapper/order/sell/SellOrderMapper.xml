<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.hurry.data.mapper.order.sell.SellOrderMapper">

	<resultMap id="SellOrderResultMap" type="SellOrder">
		<id property="id" column="id" />
		<result property="storeId" column="storeId"/>
		<association property="orderGoods" column="id" select="cn.hurry.data.mapper.order.sell.SellOrderGoodsMapper.selectSellOrderGoodsByOrderId"></association>
		<collection property="user" column="userId" ofType="User" select="cn.hurry.data.mapper.user.UserMapper.selectUserById"></collection>
		<collection property="store" column="storeId" ofType="Store" select="cn.hurry.data.mapper.store.StoreMapper.selectStoreById"></collection>
	</resultMap>

	<sql id="selectWhere">
		<if test="status != null">
			AND sell_order.status=#{status}
		</if>
		<if test="id!=null">
			AND (sell_order.id LIKE CONCAT(CONCAT('%',#{id},'%')))  
		</if>
		<if test="storeId != null">
			AND  sell_order.storeId =#{storeId}
		</if>
		<if test="createDateStart!=null">
			AND  sell_order.createDate &gt;=#{createDateStart}
		</if>
		<if test="createDateEnd!=null">
			AND  sell_order.createDate &lt;=#{createDateEnd}
		</if>
		<if test="userId != null">
			AND  sell_order.userId =#{userId}
		</if>
		<if test="goodsId != null">
			AND  sell_order_goods.`goodsId` =#{goodsId}
		</if>
	</sql>

	<insert id="insertSellOrder" parameterType="SellOrder">
		INSERT INTO `sell_order` 
		(id,storeId,remark,createDate,userId,status,type,pay,payType)
		VALUES
		(#{id},#{storeId},#{remark},#{createDate},#{userId},#{status},#{type},#{pay},#{payType})
	</insert>

	<update id="updateSellOrder" parameterType="SellOrder">
		UPDATE `sell_order` 
		<set>
			<if test="remark!=null">
				remark=#{remark},
			</if>
			<if test="userId !=0">
				userId=#{userId},
			</if>
			<if test="storeId !=0">
				storeId=#{storeId},
			</if>
			status=#{status},
			pay=#{pay}
		</set>
		WHERE id=#{id}
	</update>

	<delete id="deleteSellOrder" parameterType="SellOrder">
		DELETE FROM `sell_order` WHERE id = #{id}
	</delete>

	<select id="selectSellOrderById" parameterType="String" resultMap="SellOrderResultMap">
		SELECT * FROM `sell_order` WHERE id = #{id}
	</select>

	<select id="selectSellOrderByMap" parameterType="map" resultMap="SellOrderResultMap">
		SELECT DISTINCT sell_order.* FROM `sell_order`
		LEFT JOIN sell_order_goods ON sell_order_goods.`orderId`=sell_order.`id`
		<where>
			<include refid="selectWhere"/>
		</where>
		<if test="sortField!=null and sortField!=''">
			ORDER BY ${sortField} ${sortOrder}
		</if>
		<if test="sortField==null or sortField==''">
			ORDER BY id DESC
		</if>
		<if test="firstResult != null">
			<if test="maxResults != null">
				LIMIT ${firstResult},${maxResults}
			</if>
		</if>
	</select>
	
	<select id="countSellOrderByMap" parameterType="map" resultType="int">
		SELECT count(id) FROM `sell_order`
		<where>
			<include refid="selectWhere"/>
		</where>
	</select>
	
	<select id="sumSellOrderByMap" parameterType="map" resultType="double">
		SELECT sum(pay) FROM `sell_order`
		<where>
			<include refid="selectWhere"/>
		</where>
		<if test="sortField!=null and sortField!=''">
			ORDER BY ${sortField} ${sortOrder}
		</if>
		<if test="sortField==null and sortField==''">
			ORDER BY id DESC
		</if>
		<if test="firstResult != null">
			<if test="maxResults != null">
				LIMIT ${firstResult},${maxResults}
			</if>
		</if>
	</select>
	
	<select id="selectMaxId" resultType="string">
		SELECT MAX(id) AS maxId FROM `sell_order` 
		WHERE DATEDIFF(NOW(),createDate)=0
	</select>
	
</mapper> 